# API Type Synchronization Workflow

This document explains how to work with the automated API type synchronization system between the backend (Python/Pydantic) and frontend (TypeScript).

## Overview

Frontend TypeScript types are automatically generated from the backend's OpenAPI specification. This ensures type safety across the full stack and prevents API contract mismatches at compile time.

**Key Files:**
- `backend/openapi.json` - OpenAPI specification (committed to repo)
- `backend/scripts/generate_openapi.py` - Generates OpenAPI spec from FastAPI app
- `frontend/src/types/api-generated.ts` - Auto-generated TypeScript types (committed to repo)
- `frontend/src/types/index.ts` - Barrel file with type aliases for backward compatibility

## When to Regenerate Types

Regenerate types whenever you change backend API schemas:
- Add/modify/remove Pydantic request/response models
- Change field types, add/remove fields
- Modify API endpoint parameters or return types

## Step-by-Step Workflow

### 1. Make Backend Schema Changes

Edit your Pydantic models in the backend:

```python
# backend/app/schemas/user.py
class UserResponse(BaseModel):
    id: str
    email: str
    new_field: str  # Added new field
```

### 2. Regenerate OpenAPI Specification

```bash
cd backend
uv run python scripts/generate_openapi.py
```

This generates `backend/openapi.json` from your FastAPI app.

### 3. Regenerate Frontend Types

```bash
cd frontend
npm run generate-types
```

This does two things:
1. Runs `openapi-typescript` to generate types from `backend/openapi.json`
2. Runs `prettier` to format the generated types (removes semicolons, etc.)

### 4. Fix TypeScript Compilation Errors

The TypeScript compiler will now show errors where your frontend code doesn't match the new backend schema:

```typescript
// frontend/src/components/UserProfile.tsx
// TypeScript error: Property 'new_field' is missing
const user: UserResponse = await getCurrentUser()
console.log(user.new_field)  // Add usage of new field
```

This is a **feature, not a bug** - the type system catches API contract mismatches at compile time instead of runtime.

### 5. Commit All Changes

Commit the OpenAPI spec, generated types, and frontend fixes together:

```bash
git add backend/openapi.json frontend/src/types/api-generated.ts frontend/src/
git commit -m "feat: add new_field to UserResponse schema"
```

## Type Organization

### Generated Types (`frontend/src/types/api-generated.ts`)

**DO NOT EDIT THIS FILE MANUALLY**. It's auto-generated and will be overwritten.

Contains raw OpenAPI-generated types:
```typescript
export interface components {
  schemas: {
    UserResponse: {
      id: string
      email: string
      new_field: string
    }
  }
}
```

### Barrel File (`frontend/src/types/index.ts`)

Re-exports types with convenient aliases:

```typescript
export type { components, paths, operations } from './api-generated'
import type { components } from './api-generated'

export type UserResponse = components['schemas']['UserResponse']
export type LineResponse = components['schemas']['LineResponse']
// ... more type aliases
```

**When to edit:** Add new type aliases when new schemas are added to the backend.

### Frontend-Only Types (`frontend/src/lib/api.ts`)

Some types exist only in the frontend:
- `HealthResponse` / `RootResponse` - Simple inline types not in backend schemas
- `Contact` - Union type (`EmailResponse | PhoneResponse`)
- `NetworkGraph` - Record type for graph data structure
- `RecentLogsParams` / `AdminUsersParams` - Query parameter helpers

These remain manually defined in `api.ts`.

## Common Issues

### Issue: TypeScript Errors After Regeneration

**Symptom:** Frontend fails to compile with type errors.

**Cause:** Backend schema changes broke frontend code.

**Solution:** This is expected! Fix the frontend code to match the new schema. The type system is protecting you from runtime errors.

### Issue: `undefined` vs `null` Type Mismatches

**Symptom:**
```typescript
// Error: Type 'string | null | undefined' is not assignable to type 'string | null'
<UserStatusBadge deletedAt={user.deleted_at} />
```

**Cause:** Generated types use `undefined` for optional fields, but component props expect `null`.

**Solution:** Use nullish coalescing:
```typescript
<UserStatusBadge deletedAt={user.deleted_at ?? null} />
```

### Issue: CI Fails with "Types Out of Sync"

**Symptom:** CI build fails with error about `src/types/api-generated.ts` having uncommitted changes.

**Cause:** You changed backend schemas but didn't regenerate and commit frontend types.

**Solution:**
1. Run `npm run generate-types` in frontend directory
2. Commit the updated `src/types/api-generated.ts` file
3. Push the changes

### Issue: Semicolons Added to Generated File

**Symptom:** `git diff` shows semicolons added to every line in `api-generated.ts`.

**Cause:** The `generate-types` script should run prettier automatically, but it might have failed.

**Solution:**
```bash
cd frontend
npm run generate-types  # This runs prettier automatically
```

The `generate-types` script includes `&& prettier --write src/types/api-generated.ts` to fix formatting.

## CI Integration

The CI pipeline verifies type synchronization:

```yaml
# .github/workflows/ci.yml
- name: Verify API types are in sync
  working-directory: frontend
  run: npm run check-types-sync
```

This runs `npm run generate-types` and checks if `git diff` shows any changes. If types are out of sync, the build fails.

## Benefits of This Approach

1. **Type Safety** - Backend schema changes immediately cause frontend compilation errors
2. **Single Source of Truth** - Backend Pydantic models define the API contract
3. **Catch Errors Early** - Compile-time errors instead of runtime failures
4. **Documentation** - Generated types serve as API documentation
5. **Refactoring Safety** - Rename fields in backend, TypeScript catches all frontend usages

## See Also

- [ADR 14: API Type Synchronization](./adr/14-api-type-synchronization.md) - Design decisions and rationale
- [ADR 10: Testing Strategy](./adr/10-testing.md) - Test coverage exclusions for build scripts
- [openapi-typescript documentation](https://openapi-ts.dev/) - Type generation tool docs
