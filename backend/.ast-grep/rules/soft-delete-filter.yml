id: soft-delete-filter
language: python
severity: error
message: |
  SELECT query on soft-deletable model must include .where($$$Model.deleted_at.is_(None)) filter

  Models with soft delete: UserRoute, UserRouteSegment, UserRouteSchedule,
  UserRouteStationIndex, NotificationPreference

  Example fix:
    select(UserRoute).where(
      UserRoute.id == route_id,
      UserRoute.deleted_at.is_(None),  # Add this line
    )

note: |
  This rule helps prevent accidental inclusion of soft-deleted records in queries.
  All SELECT queries on models with deleted_at column must filter by deleted_at.is_(None).

rule:
  any:
    - pattern: select($MODEL).where($$$)
      constraints:
        MODEL:
          any:
            - regex: "UserRoute(?!Segment|Schedule|StationIndex)"
            - regex: "UserRouteSegment"
            - regex: "UserRouteSchedule"
            - regex: "UserRouteStationIndex"
            - regex: "NotificationPreference"
      not:
        has:
          pattern: $$$Model.deleted_at.is_(None)
    - pattern: |
        select($MODEL)
          .join($$$)
          .where($$$)
      constraints:
        MODEL:
          any:
            - regex: "UserRoute(?!Segment|Schedule|StationIndex)"
            - regex: "UserRouteSegment"
            - regex: "UserRouteSchedule"
            - regex: "UserRouteStationIndex"
            - regex: "NotificationPreference"
      not:
        has:
          pattern: $$$Model.deleted_at.is_(None)

fix: |
  Add .where($$$Model.deleted_at.is_(None)) to the query chain

metadata:
  category: data-integrity
  technology:
    - sqlalchemy
    - python
  cwe: CWE-670
  references:
    - https://github.com/mnbf9rca/IsTheTubeRunning/issues/233
